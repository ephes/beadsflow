beads_dir = ".beads"
interval_seconds = 30
log_level = "info"
implementer = "codex"
reviewer = "claude"

[implementers.codex]
command = """bash -lc 'set -euo pipefail
issue="$BEADSFLOW_ISSUE_ID"
epic="$BEADSFLOW_EPIC_ID"
msgfile="$(mktemp -t beadsflow-codex-msg.XXXXXX)"
trap "rm -f \\"$msgfile\\"" EXIT

bd --no-daemon sync --import-only >/dev/null 2>&1 || true
before_sig="$( (git diff; git diff --staged; git ls-files --others --exclude-standard | LC_ALL=C sort) | shasum -a 256 | cut -d" " -f1 )"

codex --ask-for-approval never exec --sandbox workspace-write --output-last-message "$msgfile" "Implement bead ${issue} under epic ${epic}. First, read the bead and deps using JSONL mode: bd --no-daemon --no-db show ${issue}; bd --no-daemon --no-db dep tree ${issue}. Implement the acceptance criteria by editing files in this repo. Ensure there is a non-empty git diff when done. Do not post Beads comments yourself."

after_sig="$( (git diff; git diff --staged; git ls-files --others --exclude-standard | LC_ALL=C sort) | shasum -a 256 | cut -d" " -f1 )"
if [ "$after_sig" = "$before_sig" ]; then
  bd --no-daemon comment "$issue" "Implementer finished but produced no new working-tree changes; stopping."
  exit 1
fi

just test
just typecheck
just lint

body="$(cat "$msgfile")"
comment_text="$(cat <<EOF
Ready for review:

$body

Validation:
- just test
- just typecheck
- just lint
EOF
)"
bd --no-daemon comment "$issue" "$comment_text"
'"""

[reviewers.claude]
command = """bash -lc 'set -euo pipefail
issue="$BEADSFLOW_ISSUE_ID"
epic="$BEADSFLOW_EPIC_ID"

bd --no-daemon sync --import-only >/dev/null 2>&1 || true
out="$(claude -p "Review bead ${issue} under epic ${epic}. Review the repo state and changes. Respond with a Beads comment. The first non-empty line must be exactly LGTM or start with Changes requested:. Do not wrap that marker in markdown/backticks.")"

bd --no-daemon comment "$issue" "$out"
'"""

[run]
max_iterations = 500
resume_in_progress = true
selection_strategy = "priority_then_oldest"
on_command_failure = "stop"
command_timeout_seconds = 3600
